name: build-and-publish

on:
  pull_request:
    types: [closed]

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 16
      - run: npm install
      - run: npm test
      - run: npm run build

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-github-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 16
      - name: Get version from package.json
        id: get_version
        run: echo ::set-output name=version::$(node -p "require('./package.json').version")
      - name: Sign the build files
        id: sign_build
        run: |
          # å®‰è£… Sigstore Cosign
          curl -sfL https://raw.githubusercontent.com/sigstore/cosign/main/install.sh | sudo sh
          # å¯¹ build æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶è¿›è¡Œç­¾å
          cosign sign-blob --output-signature signature.sig --output-certificate cosign.cert build/
          # éªŒè¯ç­¾åå¹¶è·å–ç›¸å…³ä¿¡æ¯
          logIndex=$(cosign verify-blob --certificate cosign.cert --signature signature.sig build/ | grep "logIndex" | awk '{print $2}')
          signatureID=$(cosign verify-blob --certificate cosign.cert --signature signature.sig build/ | grep "Signature ID" | awk '{print $3}')
          certificateFingerprint=$(cosign verify-blob --certificate cosign.cert --signature signature.sig build/ | grep "Certificate Fingerprint" | awk '{print $3}')
          echo "logIndex: $logIndex"
          echo "signatureID: $signatureID"
          echo "certificateFingerprint: $certificateFingerprint"
          echo "::set-output name=logIndex::$logIndex"
          echo "::set-output name=signatureID::$signatureID"
          echo "::set-output name=certificateFingerprint::$certificateFingerprint"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.TOKEN }}
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ğŸ‰ å‘å¸ƒæ–°ç‰ˆæœ¬${{ steps.get_version.outputs.version }} ğŸ‰

            **é¡¹ç›®åç§°**: MZAPI
            **ç‰ˆæœ¬å·**: ${{ steps.get_version.outputs.version }}
            **ç­¾åä¿¡æ¯**:
            - æ­¤æ¬¡å‘å¸ƒçš„ç›¸å…³åŒ…å·²ä½¿ç”¨ Sigstore è¿›è¡Œç­¾åï¼Œç¡®ä¿äº†è½¯ä»¶çš„å®Œæ•´æ€§å’Œæ¥æºçš„å¯ä¿¡æ€§ã€‚Sigstore æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨é€šè¿‡æ•°å­—ç­¾åæŠ€æœ¯ä¿æŠ¤è½¯ä»¶ä¾›åº”é“¾çš„å®‰å…¨ã€‚é€šè¿‡ Sigstore ç­¾åï¼Œç”¨æˆ·å¯ä»¥éªŒè¯è½¯ä»¶åŒ…æ˜¯å¦æœªè¢«ç¯¡æ”¹ï¼Œå¹¶ç¡®è®¤å…¶æ¥æºçš„åˆæ³•æ€§ã€‚Sigstore ä½¿ç”¨äº†å…ˆè¿›çš„åŠ å¯†æŠ€æœ¯ï¼Œä¸ºè½¯ä»¶å‘å¸ƒæä¾›äº†ä¸€å±‚å¼ºå¤§çš„ä¿æŠ¤ï¼Œé˜²æ­¢æ¶æ„è½¯ä»¶çš„ä¼ æ’­å’Œè½¯ä»¶ä¾›åº”é“¾çš„æ”»å‡»ã€‚
            - **logIndex**: ${{ steps.sign_build.outputs.logIndex }}
              è¿™æ˜¯ç­¾ååœ¨ Sigstore Transparency Log ä¸­çš„ç´¢å¼•ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ­¤æ¬¡ç­¾åã€‚Transparency Log æ˜¯ä¸€ä¸ªå…¬å¼€çš„ã€ä¸å¯ç¯¡æ”¹çš„æ—¥å¿—ï¼Œè®°å½•äº†æ‰€æœ‰çš„ç­¾åä¿¡æ¯ï¼Œç¡®ä¿äº†ç­¾åçš„é€æ˜æ€§å’Œå¯è¿½æº¯æ€§ã€‚é€šè¿‡ logIndexï¼Œç”¨æˆ·å¯ä»¥åœ¨ Sigstore çš„ Transparency Log ä¸­æŸ¥è¯¢åˆ°æ­¤æ¬¡ç­¾åçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç­¾åçš„æ—¶é—´ã€ç­¾åè€…ç­‰ã€‚
            - **Signature ID**: ${{ steps.sign_build.outputs.signatureID }}
              è¿™æ˜¯ç­¾åçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨ Sigstore ä¸­æŸ¥æ‰¾å’ŒéªŒè¯ç­¾åã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ Signature ID åœ¨ Sigstore çš„ Transparency Log ä¸­æŸ¥è¯¢åˆ°æ­¤æ¬¡ç­¾åçš„è¯¦ç»†ä¿¡æ¯ï¼Œç¡®ä¿ç­¾åçš„æœ‰æ•ˆæ€§å’Œå¯ä¿¡æ€§ã€‚
            - **Certificate Fingerprint**: ${{ steps.sign_build.outputs.certificateFingerprint }}
              è¿™æ˜¯ç”¨äºç­¾åçš„è¯ä¹¦çš„æŒ‡çº¹ï¼Œç”¨äºéªŒè¯ç­¾åçš„å…¬é’¥ã€‚è¯ä¹¦æŒ‡çº¹æ˜¯è¯ä¹¦çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯ä¹¦æŒ‡çº¹éªŒè¯ç­¾åæ‰€ä½¿ç”¨çš„å…¬é’¥æ˜¯å¦åˆæ³•ï¼Œç¡®ä¿ç­¾åçš„å®Œæ•´æ€§å’Œå¯ä¿¡æ€§ã€‚
            - **éªŒè¯ç­¾å**:
              æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ç­¾åï¼š
              ```bash
              cosign verify-blob \
                --certificate cosign.cert \
                --signature signature.sig \
                --logindex ${{ steps.sign_build.outputs.logIndex }} \
                build/
              ```
              å¦‚æœéªŒè¯æˆåŠŸï¼Œå°†æ˜¾ç¤ºç­¾åæœ‰æ•ˆä¿¡æ¯ï¼Œè¡¨ç¤ºè½¯ä»¶åŒ…æœªè¢«ç¯¡æ”¹ä¸”æ¥æºåˆæ³•ã€‚éªŒè¯ç­¾åæ˜¯ç¡®ä¿è½¯ä»¶å®‰å…¨çš„é‡è¦æ­¥éª¤ï¼Œå»ºè®®ç”¨æˆ·åœ¨ä½¿ç”¨è½¯ä»¶åŒ…å‰è¿›è¡Œç­¾åéªŒè¯ï¼Œä»¥ä¿éšœè½¯ä»¶çš„å¯ä¿¡æ€§å’Œå®Œæ•´æ€§ã€‚
            æœ¬æ¬¡å‘å¸ƒåŒ…å«äº†ä»¥ä¸‹æ›´æ”¹ï¼š
            ${{ github.event.head_commit.message }}ï¼
          files: |
            build/
          token: ${{ secrets.TOKEN }}